# tg-bots 4 sherer

## Описание проекта

В репозитории собраны простые Telegram-боты. На данный момент реализован
бот `bracelet`, который рассчитывает набор бусин для многооборотного
браслета. Бот ведёт диалог с пользователем, по очереди запрашивая
обхват запястья, количество витков, узор, размер магнита и допустимое
отклонение. После получения всех параметров бот отправляет текстовое
описание браслета.

## Зависимости

- PHP 8.0+ с расширениями `curl` и `pdo_pgsql`.
- PostgreSQL 13+.
- Любой HTTP-сервер для обработки веб-хуков (в примерах используется
  встроенный сервер PHP).
- Зарегистрированный токен Telegram-бота.

## Развёртывание

1. Склонируйте репозиторий и перейдите в каталог проекта.
2. Скопируйте файл `bracelet/.env.example` в `.env.bracelet` (для своего бота используйте `<имя_бота>/.env.example` → `.env.<имя_бота>`) и заполните переменные.
   приложение завершится с ошибкой. В рабочем окружении **обязательно**
   задайте `WEBHOOK_SECRET` — уникальную строку, которую необходимо
   передать при регистрации веб‑хука. Без этого токена бот сможет
   опираться только на проверку IP‑адреса, что потенциально позволяет
   злоумышленнику с доступом к сети Telegram или неправильно
   настроенному прокси отправлять поддельные запросы.
3. Загрузите переменные окружения из соответствующего файла:

   ```bash
   set -a
   source .env.bracelet
   set +a
   ```

4. Подготовьте базу данных PostgreSQL:

   ```bash
   createdb "$DB_NAME"
   psql -U "$DB_USER" -d "$DB_NAME" -f bracelet/sql/schema.sql
   ```

5. Запустите встроенный сервер PHP из корня проекта.
   Это позволит обрабатывать запросы как к основному боту,
   так и к тестовому по пути `/test`:

   ```bash
   php -S 0.0.0.0:8000 -t .
   ```

6. Зарегистрируйте URL веб-хука у Telegram, передав секретный токен.
   Для тестового бота укажите путь `/test/webhook.php`:

   ```bash
   curl -F "url=https://example.com/test/webhook.php" \
        -F "secret_token=$WEBHOOK_SECRET" \
        "https://api.telegram.org/bot$BOT_TOKEN/setWebhook"
   ```

## Тестирование

Для запуска автоматических тестов необходим Composer.

1. Установите зависимости разработчика:

```bash
composer install
```

2. Выполните тесты:

```bash
vendor/bin/phpunit
```

Тесты проверяют типичные и граничные значения параметров функции
`braceletText`.

## Переменные окружения

- `BOT_TOKEN` — токен вашего Telegram-бота.
- `DB_NAME` — имя базы данных PostgreSQL.
- `DB_USER` — пользователь базы данных. Обязательное значение.
- `DB_PASSWORD` — пароль пользователя базы данных. Обязательное значение.
- `DB_HOST` — адрес сервера базы данных (по умолчанию `localhost`).
- `DB_PORT` — порт сервера базы данных (по умолчанию `5432`).
- `WEBHOOK_SECRET` — секретный токен для проверки подлинности запросов.
  В продакшене значение обязательно.
- `TRUST_FORWARDED` — доверять ли заголовку `X-Forwarded-For` при определении
  IP клиента. Установите `true`, только если запросы приходят через
  контролируемый вами прокси, иначе злоумышленник может подделать заголовок
  и обойти проверку принадлежности IP сети Telegram.

Диапазоны IP, используемые для проверки запросов из Telegram,
перечислены в файле `bracelet/config/telegram_ips.php`. При обновлении
официальных диапазонов измените содержимое этого файла.

Переменная `HOST` удалена: домен мини-приложения определяется автоматически.

Без указания `DB_USER` и `DB_PASSWORD` приложение не сможет стартовать.

### Работа за обратным прокси

При размещении приложения за nginx или другим прокси необходимо передавать
реальный IP клиента и включить переменную `TRUST_FORWARDED`:

```dotenv
WEBHOOK_SECRET=ваш_секрет
TRUST_FORWARDED=true
```

Пример конфигурации nginx:

```nginx
location /webhook.php {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
}
```

При активной переменной `TRUST_FORWARDED` сервер берёт первый адрес из
`X-Forwarded-For`. Если прокси неправильно настроен или злоумышленник может
подменить заголовок, проверка IP станет недостоверной, поэтому используйте
эту опцию только для доверенного окружения.

## Добавление новых ботов

Каждый бот хранит собственный набор переменных окружения в отдельном файле вида `.env.<имя_бота>` в корне проекта. Алгоритм добавления нового бота:

1. Скопируйте шаблон `<имя_бота>/.env.example` в файл `.env.<имя_бота>` и заполните значения переменных.
2. В файле конфигурации бота подключите вспомогательную функцию и загрузите переменные окружения:

   ```php
   require_once __DIR__ . '/../loadEnv.php';
   loadBotEnv('<имя_бота>');
   ```

3. Используйте переменные окружения в коде так же, как и в существующих примерах.

Имена файлов `.env` должны точно соответствовать названию каталога бота. Например, для каталога `bracelet` используется файл `.env.bracelet`.

## Таблица `log`

Все расчёты сохраняются в таблицу `log`:

| Поле         | Тип          | Назначение                     |
|--------------|--------------|--------------------------------|
| id           | SERIAL PK    | Уникальный идентификатор       |
| tg_user_id   | BIGINT       | ID пользователя Telegram       |
| wrist_cm     | NUMERIC(5,1) | Обхват запястья, см            |
| wraps        | INT          | Количество витков              |
| pattern      | TEXT         | Узор, переданный пользователем |
| magnet_mm    | NUMERIC(5,1) | Размер магнитного замка, мм    |
| tolerance_mm | NUMERIC(5,1) | Допуск по длине, мм            |
| result_text  | TEXT         | Сформированное описание        |
| created_at   | TIMESTAMPTZ  | Время расчёта                  |

## Логи

Все сообщения об ошибках записываются в файл `bracelet/logs/app.log`.
Если каталога `bracelet/logs` нет, он создаётся автоматически.
Каждая строка лога имеет формат:

```
[YYYY-MM-DDTHH:MM:SS+00:00] Текст ошибки
```

* В начале строки указывается временная метка в формате ISO 8601.
* Далее следует человеко‑читабельное описание проблемы.

Каталог `bracelet/logs` присутствует в репозитории, однако при его
отсутствии он будет создан автоматически. Файлы с расширением `.log`
игнорируются системой контроля версий.
