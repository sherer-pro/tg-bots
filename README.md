# tg-bots

## Описание проекта

В репозитории собраны простые Telegram-боты. На данный момент реализован
бот `bracelet`, который рассчитывает набор бусин для многооборотного
браслета. Пользователь вводит параметры через мини-веб-приложение в
интерфейсе Telegram, после чего бот отправляет текстовое описание
браслета.

## Зависимости

- PHP 8.0+ с расширениями `curl` и `pdo_pgsql`.
- PostgreSQL 13+.
- Любой HTTP-сервер для обработки веб-хуков (в примерах используется
  встроенный сервер PHP).
- Зарегистрированный токен Telegram-бота.

## Развёртывание

1. Склонируйте репозиторий и перейдите в каталог проекта.
2. Скопируйте файл `.env.example` в `.env` и заполните переменные.
   Переменные `DB_USER` и `DB_PASSWORD` должны быть заданы, иначе
   приложение завершится с ошибкой.
3. Загрузите переменные в окружение:

   ```bash
   set -a
   source .env
   set +a
   ```

4. Подготовьте базу данных PostgreSQL:

   ```bash
   createdb "$DB_NAME"
   psql -U "$DB_USER" -d "$DB_NAME" -f bracelet/sql/schema.sql
   ```

5. Разместите содержимое каталога `bracelet/webapp` на HTTPS-хосте,
   который будет открываться из Telegram.
6. Запустите обработчик веб-хука:

   ```bash
   php -S 0.0.0.0:8000 -t bracelet
   ```

7. Зарегистрируйте URL веб-хука у Telegram:

   ```bash
   curl -F "url=https://$HOST/webhook.php" \
        "https://api.telegram.org/bot$BOT_TOKEN/setWebhook"
   ```

## Тестирование

Для запуска автоматических тестов необходим Composer.

1. Установите зависимости разработчика:

```bash
composer install
```

2. Выполните тесты:

```bash
vendor/bin/phpunit
```

Тесты проверяют типичные и граничные значения параметров функции
`braceletText`.

## Переменные окружения

- `BOT_TOKEN` — токен вашего Telegram-бота.
- `HOST` — домен, где будет доступно веб-приложение.
- `DB_NAME` — имя базы данных PostgreSQL.
- `DB_USER` — пользователь базы данных. Обязательное значение.
- `DB_PASSWORD` — пароль пользователя базы данных. Обязательное значение.
- `DB_HOST` — адрес сервера базы данных (по умолчанию `localhost`).
- `DB_PORT` — порт сервера базы данных (по умолчанию `5432`).
- `WEBHOOK_SECRET` — секретный токен для проверки подлинности запросов.

Без указания `DB_USER` и `DB_PASSWORD` приложение не сможет стартовать.

## Таблица `log`

Все расчёты сохраняются в таблицу `log`:

| Поле         | Тип          | Назначение                     |
|--------------|--------------|--------------------------------|
| id           | SERIAL PK    | Уникальный идентификатор       |
| tg_user_id   | BIGINT       | ID пользователя Telegram       |
| wrist_cm     | NUMERIC(5,1) | Обхват запястья, см            |
| wraps        | INT          | Количество витков              |
| pattern      | TEXT         | Узор, переданный пользователем |
| magnet_mm    | NUMERIC(5,1) | Размер магнитного замка, мм    |
| tolerance_mm | NUMERIC(5,1) | Допуск по длине, мм            |
| result_text  | TEXT         | Сформированное описание        |
| created_at   | TIMESTAMPTZ  | Время расчёта                  |

## Веб-приложение

Каталог `bracelet/webapp` содержит минимальную HTML-страницу,
запускаемую внутри Telegram. Форма собирает параметры браслета и
передаёт их боту через механизм [Telegram Web Apps](https://core.telegram.org/bots/webapps).

## Логи

Все сообщения об ошибках записываются в файл `bracelet/logs/app.log`.
Каждая строка лога имеет формат:

```
[YYYY-MM-DDTHH:MM:SS+00:00] Текст ошибки
```

* В начале строки указывается временная метка в формате ISO 8601.
* Далее следует человеко‑читабельное описание проблемы.

Каталог `bracelet/logs` создан в репозитории, но файлы с расширением
`.log` игнорируются системой контроля версий.

