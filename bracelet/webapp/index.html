<!DOCTYPE html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bracelet Calc</title>
<style>
    body{font-family:sans-serif;margin:16px;}
    label{display:block;margin:8px 0;}
    input{width:90px;}
    button{padding:8px 16px;}
    .error{color:#c00;margin-top:8px;}
</style>
<h3 id="ttl">Параметры</h3>
<form id="f">
    <label id="l1"></label>
    <label id="l2"></label>
    <label id="l3"></label>
    <label id="l4"></label>
    <label id="l5"></label>
    <button type="submit" id="btn">Рассчитать</button>
    <div id="err" class="error"></div>
</form>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    const tg   = window.Telegram.WebApp;
    const lang = tg.initDataUnsafe.user?.language_code?.startsWith('en') ? 'en' : 'ru';

    const txt = {
        ru: {
            ttl:'Параметры', wrist:'Обхват запястья, см',
            wraps:'Оборотов', pattern:'Узор (через точку с запятой, мм)',
            mag:'Магнит, мм', tol:'Допуск, мм', btn:'Рассчитать',
            err:'Заполни все поля корректно (узор: числа через точку с запятой)'
        },
        en: {
            ttl:'Parameters', wrist:'Wrist, cm',
            wraps:'Wraps', pattern:'Pattern (semicolon‑sep, mm)',
            mag:'Magnet, mm', tol:'Slack, mm', btn:'Calculate',
            err:'Please fill all fields correctly (pattern: numbers separated by semicolons)'
        }
    }[lang];

    document.title         = txt.ttl;
    document.getElementById('ttl').textContent = txt.ttl;
    document.getElementById('l1').innerHTML    = `${txt.wrist} <input name="wrist_cm" type="number" step="0.1" required>`;
    document.getElementById('l2').innerHTML    = `${txt.wraps} <input name="wraps" type="number" min="1" required>`;
    document.getElementById('l3').innerHTML    = `${txt.pattern} <input name="pattern" value="10;10;10;8" required>`;
    document.getElementById('l4').innerHTML    = `${txt.mag} <input name="magnet_mm" value="10" required>`;
    document.getElementById('l5').innerHTML    = `${txt.tol} <input name="tolerance_mm" value="5" required>`;
    document.getElementById('btn').textContent = txt.btn;

    tg.expand();

    const form = document.getElementById('f');
    const err  = document.getElementById('err');

    form.addEventListener('submit', e => {
        e.preventDefault();
        err.textContent = '';

        const data = Object.fromEntries(new FormData(form).entries());
        /**
         * Проверяем корректность введённых данных.
         * Регулярное выражение допускает только числа,
         * разделённые точкой с запятой; вокруг точки с запятой
         * могут располагаться произвольные пробелы.
         * В дробной части разрешены как точки, так и запятые.
         */
        const ok = /^\d+(?:[.,]\d+)?(?:\s*;\s*\d+(?:[.,]\d+)?)*$/.test(data.pattern)
            && +data.wrist_cm>0 && +data.wraps>0;

        if (!ok) {
            err.textContent = txt.err;
            return;
        }
        data.lang = lang;
        tg.sendData(JSON.stringify(data));
        tg.close();
    });
</script>
