<?php

declare(strict_types=1);
require_once __DIR__ . '/logger.php'; // –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É

try {
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –≥–¥–µ —á–∏—Ç–∞—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    require 'config.php';
} catch (Throwable $e) {
    // –ï—Å–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞,
    // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –µ—ë –≤ –ª–æ–≥–µ –∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    logError('–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ' . $e->getMessage());
    exit;
}

require_once 'calc.php'; // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–∞ –±—Ä–∞—Å–ª–µ—Ç–∞
// –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ IP-–∞–¥—Ä–µ—Å–æ–≤ Telegram –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª,
// —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ.
require_once __DIR__ . '/telegram_ip.php'; // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ IP

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞, —É—á–∏—Ç—ã–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏.
 *
 * –ü–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏–º–µ–Ω–∞ –≤—Å–µ—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫
 * –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞.
 *
 * –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–∞—è:
 * 1. –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Forwarded-For` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –±–µ—Ä—ë—Ç—Å—è –ø–µ—Ä–≤—ã–π IP –∏–∑
 *    –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é.
 * 2. –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `REMOTE_ADDR` –∏–∑ `$_SERVER`.
 *
 * @param array<string, string> $headers –ó–∞–≥–æ–ª–æ–≤–∫–∏ –≤—Ö–æ–¥—è—â–µ–≥–æ HTTP-–∑–∞–ø—Ä–æ—Å–∞.
 * @param array<string, mixed>  $server  –î–∞–Ω–Ω—ã–µ –æ –∑–∞–ø—Ä–æ—Å–µ, –æ–±—ã—á–Ω–æ `$_SERVER`.
 *
 * @return string IP-–∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
 */
function resolveRemoteIp(array $headers, array $server): string
{
    // –ü—Ä–∏–≤–æ–¥–∏–º –∏–º–µ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
    $normalized = array_change_key_case($headers, CASE_LOWER);

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ IP
    if (!empty($normalized['x-forwarded-for'])) {
        $forwarded = explode(',', $normalized['x-forwarded-for']);
        return trim($forwarded[0]);
    }

    // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º REMOTE_ADDR
    return $server['REMOTE_ADDR'] ?? '';
}

if (!defined('WEBHOOK_LIB')):

// –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º IP-–∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
$headers  = function_exists('getallheaders') ? getallheaders() : [];
/**
 * –ü—Ä–∏–≤–æ–¥–∏–º –∏–º–µ–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
 * –æ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç
 * –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞ –∏ –¥—Ä—É–≥–∏—Ö
 * –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
 */
$headers  = array_change_key_case($headers, CASE_LOWER);
$remoteIp = resolveRemoteIp($headers, $_SERVER);

/**
 * –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω, –∑–∞–¥–∞–Ω–Ω—ã–π –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
 * –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ø—É—Å—Ç–∏–º–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ.
 *
 * @var string $secret
 */
$secret = $_ENV['WEBHOOK_SECRET'] ?? getenv('WEBHOOK_SECRET') ?: '';

if ($secret === '') {
    // –í —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å.
    // –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ–∫–µ–Ω–∞ –æ—Ç–∫–ª—é—á–∞–µ–º, —á—Ç–æ–±—ã –±—ã–ª–æ —É–¥–æ–±–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
    // –±–æ—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    // ‚ö† –í –±–æ–µ–≤–æ–π —Å—Ä–µ–¥–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∑–≤–æ–ª–∏—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞–º
    // –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –Ω–∞—à–µ–º—É webhook –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å
    // –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
    $tokenValid = true;
} else {
    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ–∂–∏–¥–∞–µ–º—ã–π —Ç–æ–∫–µ–Ω —Å —Ç–µ–º, —á—Ç–æ –ø—Ä–∏—à—ë–ª –≤ –∑–∞–ø—Ä–æ—Å–µ –æ—Ç Telegram.
    $tokenValid = isset($headers['x-telegram-bot-api-secret-token'])
        && hash_equals($secret, $headers['x-telegram-bot-api-secret-token']);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à—ë–ª –æ—Ç Telegram (–ø–æ —Ç–æ–∫–µ–Ω—É –∏–ª–∏ IP)
if (!$tokenValid && !isTelegramIP($remoteIp)) {
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–º –∑–∞–ø—Ä–æ—Å–µ –≤ –ª–æ–≥, –≤–∫–ª—é—á–∞—è —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    logError('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –∑–∞–ø—Ä–æ—Å: IP ' . $remoteIp . ', —Ç–æ–∫–µ–Ω: ' . ($headers['x-telegram-bot-api-secret-token'] ?? ''));
    http_response_code(403);
    exit;
}

// –°—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON
$body   = file_get_contents('php://input');
$update = json_decode($body, true);
if ($update === null && json_last_error() !== JSON_ERROR_NONE) {
    // –ï—Å–ª–∏ JSON –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, —Ñ–∏–∫—Å–∏—Ä—É–µ–º —ç—Ç–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 400
    logError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –≤–æ –≤—Ö–æ–¥—è—â–µ–º –∑–∞–ø—Ä–æ—Å–µ: ' . $body);
    http_response_code(400);
    exit;
}
if (!isset($update['message'])) {
    exit;
}
$msg    = $update['message'];
$chatId = $msg['chat']['id'];

try {
    // –ü—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
    $pdo = new PDO(DB_DSN, DB_USER, DB_PASSWORD, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
    ]);
} catch (PDOException $e) {
    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ª–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏
    $userLang = $msg['from']['language_code'] ?? 'ru';
    $text     = $userLang === 'en'
        ? 'Database connection error. Please try again later.'
        : '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
    logError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: ' . $e->getMessage());
    send($text, $chatId);
    exit;
}

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—É /start, –¥–æ–ø—É—Å–∫–∞—é—â—É—é –ø–µ—Ä–µ–¥–∞—á—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
if (isset($msg['text']) && strncmp($msg['text'], '/start', 6) === 0) {
    /**
     * –ü–∞—Ä–∞–º–µ—Ç—Ä, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –≤–º–µ—Å—Ç–µ —Å –∫–æ–º–∞–Ω–¥–æ–π /start.
     * –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª –∞—Ä–≥—É–º–µ–Ω—Ç, –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
     *
     * @var string $startParam
     */
    $startParam = substr($msg['text'], 7);
    // –ó–¥–µ—Å—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å $startParam (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª–∞)

    $kb = [
        'keyboard' => [[[
            'text' => 'üßÆ Calculator',
            'web_app' => ['url' => WEBAPP_URL]
        ]]],
        'resize_keyboard' => true
    ];
    // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    $sent = send('–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, –∑–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É –∏ –ø–æ–ª—É—á–∏ —Ä–∞—Å—á—ë—Ç', $chatId, ['reply_markup' => json_encode($kb)]);
    if (!$sent) {
        // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        send('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.', $chatId);
    }
    exit;
}

if (isset($msg['web_app_data']['data'])) {
    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ web_app –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å JSON
    $raw = $msg['web_app_data']['data'];
    $d   = json_decode($raw, true);
    if ($d === null && json_last_error() !== JSON_ERROR_NONE) {
        // –ü—Ä–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º JSON —Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        logError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –≤ web_app_data: ' . $raw);
        $userLang = $msg['from']['language_code'] ?? 'ru';
        $text     = $userLang === 'en' ? 'Error in data. Try again.' : '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
        if (!send($text, $chatId)) {
            $fallback = $userLang === 'en'
                ? 'Failed to send message. Try again later.'
                : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
            send($fallback, $chatId);
        }
        exit;
    }
    $lang = $d['lang'] ?? 'ru';

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
    if (!isValidWebAppData($d)) {
        logError('–ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ web_app_data: ' . json_encode($msg['web_app_data'], JSON_UNESCAPED_UNICODE));
        $text = $lang === 'en' ? 'Error in data. Try again.' : '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –Ω–µ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏
        if (!send($text, $chatId)) {
            $fallback = $lang === 'en'
                ? 'Failed to send message. Try again later.'
                : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
            send($fallback, $chatId);
        }
        exit;
    }

    try {
        // –ü—Ä–∏–≤–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —É–∑–æ—Ä–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –≤–∏–¥—É:
        // 1. —É–±–∏—Ä–∞–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –≤–≤–æ–¥–∏—Ç—å
        //    –∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª –ø–æ –ø—Ä–∏–≤—ã—á–∫–µ;
        // 2. –∑–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏ –Ω–∞ —Ç–æ—á–∫–∏, —Ç–∞–∫ –∫–∞–∫
        //    –¥–∞–ª–µ–µ –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —á–∏—Å–ª–∞ —Å —Ç–æ—á–∫–æ–π;
        // 3. —ç–ª–µ–º–µ–Ω—Ç—ã —É–∑–æ—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω—ã —Ç–æ—á–∫–æ–π —Å –∑–∞–ø—è—Ç–æ–π,
        //    —á—Ç–æ–±—ã —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å –¥–µ—Å—è—Ç–∏—á–Ω–æ–π –∑–∞–ø—è—Ç–æ–π.
        $patternStr = str_replace(' ', '', str_replace(',', '.', $d['pattern']));

        /**
         * –ú–∞—Å—Å–∏–≤ –¥–∏–∞–º–µ—Ç—Ä–æ–≤ –±—É—Å–∏–Ω, –∑–∞–¥–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
         * –ö–∞–∂–¥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ float –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.
         *
         * @var float[] $pattern
         */
        $pattern = array_map('floatval', explode(';', $patternStr));

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –±—Ä–∞—Å–ª–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏
        // –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —É–∑–æ—Ä–∞
        $text = braceletText(
            (float)$d['wrist_cm'],
            (int)  $d['wraps'],
            $pattern,
            (float)$d['magnet_mm'],
            (float)$d['tolerance_mm'],
            $lang
        );

        $stmt = $pdo->prepare('INSERT INTO log'
            . ' (tg_user_id,wrist_cm,wraps,pattern,magnet_mm,tolerance_mm,result_text)'
            . ' VALUES (?,?,?,?,?,?,?)');
        $stmt->execute([
            $msg['from']['id'], $d['wrist_cm'], $d['wraps'],
            $d['pattern'], $d['magnet_mm'], $d['tolerance_mm'], $text
        ]);
    } catch (\Throwable $e) {
        // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        logError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SQL: ' . $e->getMessage());
        $text = $lang === 'en' ? 'Error in data. Try again.' : '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.';
    }
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –æ —Å–±–æ–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if (!send($text, $chatId)) {
        $fallback = $lang === 'en'
            ? 'Failed to send message. Try again later.'
            : '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.';
        send($fallback, $chatId);
    }
}
endif;

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é Telegram —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ sendMessage.
 *
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç HTTP POST-–∑–∞–ø—Ä–æ—Å –∫ Bot API. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –∏
 * –ø—Ä–æ–≤–µ—Ä–∫–∏ HTTP-–∫–æ–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç JSON –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–ª–∞–≥ `ok`.
 * –ü—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ—è—Ö, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–º HTTP-—Å—Ç–∞—Ç—É—Å–µ, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º JSON –∏–ª–∏
 * `ok = false` —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ –ª–æ–≥–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`,
 * –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç.
 *
 * –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –≤–æ–∑–≤—Ä–∞—Ç–∞ `false`:
 * - –æ—à–∏–±–∫–∞ cURL (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è);
 * - HTTP-–∫–æ–¥ –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 2xx;
 * - –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –≤ –æ—Ç–≤–µ—Ç–µ Bot API;
 * - `ok` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ `false` (—Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ—Ä—ë—Ç—Å—è –∏–∑
 *   –ø–æ–ª—è `description`).
 *
 * @param string     $text  –¢–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
 * @param int|string $chat  –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞ –∏–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 * @param array      $extra –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø—Ä–æ—Å–∞,
 *                          –Ω–∞–ø—Ä–∏–º–µ—Ä `reply_markup`.
 *
 * @internal –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∞–π–º–∞—É—Ç—ã `CURLOPT_CONNECTTIMEOUT` = 5 –∏
 *           `CURLOPT_TIMEOUT` = 10.
 *
 * @return bool `true` –≤ —Å–ª—É—á–∞–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏, –∏–Ω–∞—á–µ `false`.
 */
function send($text, $chat, $extra = []) {
    $url  = API_URL . 'sendMessage';
    $data = array_merge(['chat_id' => $chat, 'text' => $text], $extra);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º cURL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST-–∑–∞–ø—Ä–æ—Å–∞
    $ch = curl_init($url);
    curl_setopt_array($ch, [
        CURLOPT_POST           => true,                     // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç–æ–¥ POST
        CURLOPT_POSTFIELDS     => http_build_query($data),  // –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ key=value
        CURLOPT_RETURNTRANSFER => true,                     // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
        CURLOPT_CONNECTTIMEOUT => 5,                        // –ñ–¥—ë–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –±–æ–ª–µ–µ 5 —Å–µ–∫—É–Ω–¥
        CURLOPT_TIMEOUT        => 10,                       // –û–±—â–µ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ ‚Äî –¥–æ 10 —Å–µ–∫—É–Ω–¥
    ]);

    $response = curl_exec($ch);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ cURL
    if ($response === false) {
        // –õ–æ–≥–∏—Ä—É–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—É—é –Ω–∞ —É—Ä–æ–≤–Ω–µ cURL –æ—à–∏–±–∫—É –∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
        logError('–û—à–∏–±–∫–∞ cURL: ' . curl_error($ch));
        curl_close($ch);
        return false;
    }

    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º HTTP-—Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
    if ($httpCode < 200 || $httpCode >= 300) {
        // –§–∏–∫—Å–∏—Ä—É–µ–º –≤ –ª–æ–≥–∞—Ö –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π HTTP-—Å—Ç–∞—Ç—É—Å –∏ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞
        logError('–û—à–∏–±–∫–∞ HTTP: —Å—Ç–∞—Ç—É—Å ' . $httpCode . '; –æ—Ç–≤–µ—Ç: ' . $response);
        return false;
    }

    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JSON-–æ—Ç–≤–µ—Ç Telegram
    $decoded = json_decode($response, true);
    if ($decoded === null && json_last_error() !== JSON_ERROR_NONE) {
        // –õ–æ–≥–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        logError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –≤ –æ—Ç–≤–µ—Ç–µ API: ' . $response);
        return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ `ok`
    if (!isset($decoded['ok']) || $decoded['ok'] === false) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ—Ç Telegram, –µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        $desc = $decoded['description'] ?? '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        logError('–û—à–∏–±–∫–∞ API Telegram: ' . $desc);
        return false;
    }

    return true; // –í—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –ø–æ—Å—Ç—É–ø–∏–≤—à–∏—Ö –∏–∑ web_app.
 *
 * –í –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è:
 * - –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π;
 * - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –∑–Ω–∞—á–µ–Ω–∏–π –æ–∂–∏–¥–∞–Ω–∏—è–º;
 * - –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ —á–∏—Å–ª–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
 *   (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—Ö–≤–∞—Ç –∑–∞–ø—è—Å—Ç—å—è < 100 —Å–º);
 * - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å—Ç—Ä–æ–∫–∏ —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º –∏ —á–∏—Å–ª–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
 *   –ø–æ—Å–ª–µ `explode`.
 *
 * @param mixed $d –î–∞–Ω–Ω—ã–µ –∏–∑ web_app_data.
 *
 * @return bool true, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã.
 */
function isValidWebAppData($d): bool {
    if (!is_array($d)) {
        return false;
    }

    $required = ['wrist_cm', 'wraps', 'pattern', 'magnet_mm', 'tolerance_mm'];
    foreach ($required as $key) {
        if (!array_key_exists($key, $d)) {
            return false;
        }
    }

    if (!is_numeric($d['wrist_cm']) || !is_numeric($d['magnet_mm']) || !is_numeric($d['tolerance_mm'])) {
        return false;
    }

    if (!is_numeric($d['wraps'])) {
        return false;
    }

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π: –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å
    // –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö.
    $wrist     = (float)$d['wrist_cm'];
    $magnet    = (float)$d['magnet_mm'];
    $tolerance = (float)$d['tolerance_mm'];
    $wraps     = (int)$d['wraps'];

    if ($wrist <= 0 || $wrist >= 100) {
        return false; // –æ–±—Ö–≤–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ (0, 100)
    }
    if ($magnet <= 0 || $magnet >= 100) {
        return false; // —Ä–∞–∑–º–µ—Ä—ã –º–∞–≥–Ω–∏—Ç–∞ –∏–∑–º–µ—Ä—è—é—Ç—Å—è –≤ –º–º, –æ–≥—Ä–∞–Ω–∏—á–∏–º 0..100
    }
    if ($tolerance <= 0 || $tolerance >= 100) {
        return false; // –¥–æ–ø—É—Å–∫ –ø–æ –¥–ª–∏–Ω–µ —Ç–∞–∫–∂–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
    }
    if ($wraps <= 0 || $wraps > 10) {
        return false; // —á–∏—Å–ª–æ –≤–∏—Ç–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º
    }

    if (!is_string($d['pattern']) || $d['pattern'] === '') {
        return false;
    }
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    if (mb_strlen($d['pattern']) > 100) {
        return false;
    }

    // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∑–∞–ø—è—Ç—ã–µ –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç–∏ –∫ —Ç–æ—á–∫–∞–º,
    // –ø–æ—Å–ª–µ —á–µ–≥–æ –¥–µ–ª–∏–º —Å—Ç—Ä–æ–∫—É –ø–æ —Ç–æ—á–∫–∞–º —Å –∑–∞–ø—è—Ç–æ–π –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–∑–æ—Ä–∞
    $patternStr = str_replace(' ', '', str_replace(',', '.', $d['pattern']));
    $parts      = array_map('trim', explode(';', $patternStr));
    if (empty($parts) || count($parts) > 20) {
        return false;
    }

    foreach ($parts as $p) {
        if (!is_numeric($p)) {
            return false;
        }
        $val = (float)$p;
        if ($val <= 0 || $val >= 100) {
            return false; // –∫–∞–∂–¥—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Å–∏–Ω—ã –≤ –º–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö
        }
    }

    if (isset($d['lang']) && !is_string($d['lang'])) {
        return false;
    }

    return true;
}

